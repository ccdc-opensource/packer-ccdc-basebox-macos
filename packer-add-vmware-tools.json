{
  "builders": [
    {
      "type": "vagrant",
      "communicator": "ssh",
      "source_path": "{{user `macinbox_image_name`}}",
      "box_name": "ccdc-basebox-VAGRANTSLASH-macosx-10.15",
      "provider": "vmware_desktop",
      "skip_add": true,
      "ssh_password": "{{user `vagrant_user_final_password`}}"
    },
    {
      "type": "vmware-vmx",
      "source_path": "{{user `macinbox_vmx_location`}}/macinbox.vmx",
      "ssh_username": "vagrant",
      "ssh_password": "{{user `vagrant_user_final_password`}}",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "sudo /sbin/halt -l ",
      "vm_name": "{{user `vmware_center_vm_name`}}",
      "output_directory": "{{ user `build_directory` }}/packer-vmware",
      "headless": false,
      "tools_upload_flavor": "",
      "vmx_data": {
        "cpuid.coresPerSocket": "1",
        "virtualHW.version": "{{ user `virtual_hw_version` }}"
      },
      "vmx_data_post": {
        "guestOS": "{{ user `guest_os_type` }}"
      }
    }
  ],
  "post-processors": [
    [
      {
        "type": "vsphere",
        "host": "{{user `vmware_center_host`}}",
        "vm_name": "{{user `vmware_center_vm_name`}}",
        "cluster": "{{user `vmware_center_cluster_name`}}",
        "datacenter": "{{user `vmware_center_datacenter`}}",
        "esxi_host": "{{user `vmware_center_esxi_host`}}",
        "datastore": "{{user `vmware_center_datastore`}}",
        "disk_mode": "thin",
        "keep_input_artifact": true,
        "vm_network": "{{user `vmware_center_vm_network`}}",
        "vm_folder": "{{user `vmware_center_vm_folder`}}",
        "overwrite": true,
        "insecure": true,
        "username": "{{user `vmware_center_username`}}",
        "password": "{{user `vmware_center_password`}}"
      },
      {
        "type": "vsphere-template",
        "host": "{{user `vmware_center_host`}}",
        "insecure": true,
        "username": "{{user `vmware_center_username`}}",
        "password": "{{user `vmware_center_password`}}",
        "datacenter": "{{user `vmware_center_datacenter`}}",
        "folder": "/packer-templates/os/macosx-10.15",
        "keep_input_artifact": true
      }
    ]
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }}",
      "scripts": [
        "{{template_dir}}/scripts/customisation-for-buildmachines.sh",
        "{{template_dir}}/scripts/install_vmware_tools_part1"
      ],
      "environment_vars": [
        "VAGRANT_USER_FINAL_PASSWORD={{user `vagrant_user_final_password`}}",
        "CUSTOMISE_FOR_BUILDMACHINE={{user `customise_for_buildmachine`}}",
        "HOME_DIR=/Users/vagrant"
      ]
    },
    {
      "type": "breakpoint",
      "note": "Allow the VMWare kernel extensions and then let the build continue"
    },
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }}",
      "scripts": [
        "{{template_dir}}/scripts/install_vmware_tools_part2",
        "{{template_dir}}/scripts/cleanup"
      ]
    }
  ],
  "variables": {
    "customise_for_buildmachine": "0",
    "vagrant_user_final_password": "{{env `VAGRANT_USER_FINAL_PASSWORD`}}",
    "vmware_center_host": "{{env `VMWARECENTER_HOST`}}",
    "vmware_center_vm_name": "{{env `VMWARECENTER_VM_NAME`}}",
    "vmware_center_cluster_name": "{{env `VMWARECENTER_CLUSTER_NAME`}}",
    "vmware_center_datacenter": "{{env `VMWARECENTER_DATACENTER`}}",
    "vmware_center_esxi_host": "{{env `VMWARECENTER_ESXI_HOST`}}",
    "vmware_center_datastore": "{{env `VMWARECENTER_DATASTORE`}}",
    "vmware_center_vm_network": "{{env `VMWARECENTER_VM_NETWORK`}}",
    "vmware_center_vm_folder": "{{env `VMWARECENTER_VM_FOLDER`}}",
    "vmware_center_username": "{{env `VMWARECENTER_USERNAME`}}",
    "vmware_center_password": "{{env `VMWARECENTER_PASSWORD`}}"
  },
  "sensitive-variables": [
    "vmware_center_password",
    "vagrant_user_final_password"
  ]
}